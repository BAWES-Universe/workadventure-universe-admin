generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Users
model User {
  id           String   @id @default(uuid())
  uuid         String   @unique // WorkAdventure user identifier
  email        String?  @unique
  name         String?
  matrixChatId String?  @map("matrix_chat_id") // Matrix ID: "@user:matrix.org"
  lastIpAddress String? @map("last_ip_address") // Last known IP address
  isGuest      Boolean  @default(false) @map("is_guest") // True for unauthenticated guest users
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  ownedUniverses    Universe[]        @relation("UniverseOwner")
  worldMemberships  WorldMember[]
  bans              Ban[]             @relation("BannedUser")
  bannedBy          Ban[]             @relation("BannedBy")
  avatars           UserAvatar[]
  favorites         Favorite[]
  followers         Follow[]          @relation("Follower")
  following         Follow[]          @relation("Following")
  friendships1      Friendship[]      @relation("User1")
  friendships2      Friendship[]      @relation("User2")
  requestedFriendships Friendship[]   @relation("RequestedBy")
  roomAccesses      RoomAccess[]
  visitCard         VisitCard?
  membershipInvitationsSent MembershipInvitation[] @relation("InvitedBy")
  membershipInvitationsReceived MembershipInvitation[] @relation("InvitedUser")
  botsCreated       Bot[] @relation("BotCreatedBy")
  botsUpdated       Bot[] @relation("BotUpdatedBy")

  @@map("users")
}

// Universes
model Universe {
  id          String   @id @default(uuid())
  slug        String   @unique // URL identifier: "my-universe"
  name        String
  description String?
  ownerId     String   @map("owner_id")
  isPublic    Boolean  @default(true) @map("is_public")
  featured    Boolean  @default(false) // For discovery
  thumbnailUrl String? @map("thumbnail_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  owner      User      @relation("UniverseOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  worlds     World[]
  bans       Ban[]
  favorites  Favorite[]
  roomAccesses RoomAccess[]

  @@map("universes")
}

// Worlds
model World {
  id          String   @id @default(uuid())
  universeId  String   @map("universe_id")
  slug        String   // URL identifier: "office-world"
  name        String
  description String?
  isPublic    Boolean  @default(true) @map("is_public")
  featured    Boolean  @default(false) // For discovery
  thumbnailUrl String? @map("thumbnail_url")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  universe   Universe     @relation(fields: [universeId], references: [id], onDelete: Cascade)
  rooms      Room[]
  members    WorldMember[]
  bans       Ban[]
  avatars    UserAvatar[]
  favorites  Favorite[]
  roomAccesses RoomAccess[]
  membershipInvitations MembershipInvitation[]

  @@unique([universeId, slug]) // Slug unique within universe
  @@map("worlds")
}

// Rooms
model Room {
  id          String   @id @default(uuid())
  worldId     String   @map("world_id")
  slug        String   // URL identifier: "lobby"
  name        String
  description String?
  mapUrl      String?  @map("map_url") // External TMJ URL (e.g., GitHub Pages)
  wamUrl      String?  @map("wam_url") // WAM file URL in map-storage (created via PUT)
  templateMapId String? @map("template_map_id") // Reference to template map if created from template
  authenticationMandatory Boolean @default(false) @map("authentication_mandatory")
  isPublic    Boolean  @default(true) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  world      World      @relation(fields: [worldId], references: [id], onDelete: Cascade)
  templateMap RoomTemplateMap? @relation(fields: [templateMapId], references: [id], onDelete: SetNull)
  favorites  Favorite[]
  roomAccesses RoomAccess[]
  bots       Bot[]

  @@unique([worldId, slug]) // Slug unique within world
  @@map("rooms")
}

// Room Access Analytics
model RoomAccess {
  id              String   @id @default(uuid())
  userUuid        String?  @map("user_uuid") // UUID from WorkAdventure (ephemeral for guests)
  userId          String?  @map("user_id") // Only set if authenticated user exists
  ipAddress       String   @map("ip_address") // IP address for tracking
  userName        String?  @map("user_name") // Name from request or user record
  userEmail       String?  @map("user_email") // Email from request or user record
  isGuest         Boolean  @default(true) @map("is_guest") // true if unauthenticated
  isAuthenticated Boolean  @default(false) @map("is_authenticated") // true if has OIDC token
  hasMembership   Boolean  @default(false) @map("has_membership") // true if has WorldMember record
  membershipTags  String[] @map("membership_tags") // Tags from membership if exists

  universeId      String   @map("universe_id")
  worldId         String   @map("world_id")
  roomId          String   @map("room_id")

  universeSlug    String   @map("universe_slug")
  worldSlug       String   @map("world_slug")
  roomSlug        String   @map("room_slug")

  playUri         String   @map("play_uri") // Full play URI

  accessedAt      DateTime @default(now()) @map("accessed_at")

  // Relations
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  universe        Universe @relation(fields: [universeId], references: [id], onDelete: Cascade)
  world           World    @relation(fields: [worldId], references: [id], onDelete: Cascade)
  room            Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([universeId, accessedAt])
  @@index([worldId, accessedAt])
  @@index([roomId, accessedAt])
  @@index([userId, accessedAt])
  @@index([ipAddress, accessedAt])
  @@index([accessedAt])
  @@map("room_accesses")
}

// World Memberships
model WorldMember {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  worldId   String   @map("world_id")
  tags      String[] // Array of tags: ["admin", "editor", "member"]
  joinedAt  DateTime @default(now()) @map("joined_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  world World @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@unique([userId, worldId])
  @@index([worldId])
  @@index([userId])
  @@map("world_members")
}

// Bans
model Ban {
  id        String    @id @default(uuid())
  userId    String?   @map("user_id")
  universeId String?  @map("universe_id")
  worldId   String?   @map("world_id")
  ipAddress String?   @map("ip_address") // IPv4 or IPv6
  reason    String?
  bannedById String?  @map("banned_by")
  bannedAt  DateTime  @default(now()) @map("banned_at")
  expiresAt DateTime? @map("expires_at") // NULL = permanent
  isActive  Boolean   @default(true) @map("is_active")

  // Relations
  user      User?     @relation("BannedUser", fields: [userId], references: [id], onDelete: Cascade)
  universe  Universe? @relation(fields: [universeId], references: [id], onDelete: SetNull)
  world     World?    @relation(fields: [worldId], references: [id], onDelete: SetNull)
  bannedBy  User?     @relation("BannedBy", fields: [bannedById], references: [id])

  @@index([userId])
  @@index([ipAddress])
  @@index([worldId])
  @@map("bans")
}

// User Avatars & Companions
model UserAvatar {
  id              String   @id @default(uuid())
  userId          String   @map("user_id")
  worldId         String   @map("world_id")
  textureIds      String[] @map("texture_ids") // Array of texture IDs: ["male1", "hat1"]
  companionTextureId String? @map("companion_texture_id")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  world World @relation(fields: [worldId], references: [id], onDelete: Cascade)

  @@unique([userId, worldId])
  @@map("user_avatars")
}

// Favorites (for future social features)
model Favorite {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  universeId String?   @map("universe_id")
  worldId    String?   @map("world_id")
  roomId     String?   @map("room_id")
  favoritedAt DateTime @default(now()) @map("favorited_at")

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  universe Universe? @relation(fields: [universeId], references: [id], onDelete: Cascade)
  world    World?   @relation(fields: [worldId], references: [id], onDelete: Cascade)
  room     Room?    @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([roomId])
  @@index([worldId])
  @@index([universeId])
  @@map("favorites")
}

// Follows (for future social features)
model Follow {
  id         String   @id @default(uuid())
  followerId String   @map("follower_id")
  followingId String @map("following_id")
  followedAt DateTime @default(now()) @map("followed_at")

  // Relations
  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// Friendships (for future social features)
model Friendship {
  id         String    @id @default(uuid())
  user1Id    String    @map("user1_id")
  user2Id    String    @map("user2_id")
  status     String    @default("pending") // pending, accepted, blocked
  requestedById String? @map("requested_by")
  createdAt  DateTime  @default(now()) @map("created_at")
  acceptedAt DateTime? @map("accepted_at")

  // Relations
  user1       User   @relation("User1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2       User   @relation("User2", fields: [user2Id], references: [id], onDelete: Cascade)
  requestedBy User?  @relation("RequestedBy", fields: [requestedById], references: [id])

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
  @@map("friendships")
}

// Visit Cards
model VisitCard {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  bio       String?  // Optional bio/description
  links     Json     // Array of { label: string, url: string } objects
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("visit_cards")
}

// Membership Invitations
model MembershipInvitation {
  id            String   @id @default(uuid())
  worldId       String   @map("world_id")
  invitedUserId String   @map("invited_user_id")
  invitedByUserId String  @map("invited_by_user_id")
  status        String   @default("pending") // pending, accepted, rejected, cancelled
  tags          String[] // Tags that will be assigned when accepted
  message       String?
  invitedAt     DateTime @default(now()) @map("invited_at")
  respondedAt   DateTime? @map("responded_at")

  // Relations
  world       World @relation(fields: [worldId], references: [id], onDelete: Cascade)
  invitedUser User  @relation("InvitedUser", fields: [invitedUserId], references: [id], onDelete: Cascade)
  invitedBy   User  @relation("InvitedBy", fields: [invitedByUserId], references: [id], onDelete: Cascade)

  @@unique([worldId, invitedUserId, status], name: "UniquePendingInvitation")
  @@index([worldId])
  @@index([invitedUserId])
  @@index([invitedByUserId])
  @@index([status])
  @@map("membership_invitations")
}

// Room Template Categories
model RoomTemplateCategory {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  icon        String?  // emoji
  order       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  templates   RoomTemplate[]

  @@map("room_template_categories")
}

// Room Templates
model RoomTemplate {
  id               String   @id @default(uuid())
  categoryId       String   @map("category_id")
  slug             String   @unique
  name             String
  shortDescription String?  @map("short_description")
  // Future fields (store but don't use in MVP UI):
  philosophy       String?
  purpose          String?
  whoItsFor        String?  @map("who_its_for")
  typicalUseCases  String[] @map("typical_use_cases")
  visibility       String   @default("public")
  isFeatured       Boolean  @default(false) @map("is_featured")
  authorId         String?  @map("author_id") // String for now, TemplateAuthor model in v2
  isActive          Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  category         RoomTemplateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  maps             RoomTemplateMap[]

  @@map("room_templates")
}

// Room Template Maps (Actual Selectable Maps)
model RoomTemplateMap {
  id                  String   @id @default(uuid())
  templateId          String   @map("template_id")
  slug                String
  name                String
  description         String?
  mapUrl              String   @map("map_url") // TMJ or WAM URL
  previewImageUrl     String?  @map("preview_image_url") // Store but don't display in MVP
  sizeLabel           String?  @map("size_label") // small | medium | large
  orientation         String   @default("orthogonal")
  tileSize            Int      @default(32) @map("tile_size")
  recommendedWorldTags String[] @map("recommended_world_tags") // Store but don't use in MVP
  authorId            String?  @map("author_id") // String for now
  order               Int      @default(0)
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  template            RoomTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  rooms               Room[]

  @@unique([templateId, slug])
  @@index([templateId])
  @@map("room_template_maps")
}

// Bots
model Bot {
  id                  String   @id @default(uuid())
  roomId              String   @map("room_id")
  name                String   @db.VarChar(100)
  description         String?
  characterTextureId  String?  @map("character_texture_id") @db.VarChar(100)
  enabled             Boolean  @default(true)
  behaviorType        String   @default("idle") @map("behavior_type") @db.VarChar(20) // 'idle', 'patrol', or 'social'
  behaviorConfig      Json     @default("{}") @map("behavior_config")
  chatInstructions    String?  @map("chat_instructions")
  movementInstructions String?  @map("movement_instructions")
  aiProviderRef       String?  @map("ai_provider_ref") @db.VarChar(100)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdById         String?  @map("created_by_id")
  updatedById          String?  @map("updated_by_id")

  room Room @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdBy User? @relation("BotCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy User? @relation("BotUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([roomId])
  @@map("bots")
}

// AI Providers
model BotsAiProvider {
  providerId        String   @id @map("provider_id") @db.VarChar(50)
  name              String   @db.VarChar(255)
  type              String   @db.VarChar(50) // 'lmstudio', 'openai', 'anthropic', 'ultravox', 'gpt-voice'
  enabled           Boolean  @default(false)
  endpoint          String?  @db.Text
  apiKeyEncrypted   String?  @map("api_key_encrypted") @db.Text // Encrypted API key: "iv:authTag:encryptedData"
  model             String?  @db.VarChar(255)
  temperature       Decimal? @db.Decimal(3, 2) @default(0.7)
  maxTokens         Int?     @map("max_tokens") @default(500)
  supportsStreaming Boolean  @default(true) @map("supports_streaming")
  settings          Json?    @default("{}") // Provider-specific settings
  tested            Boolean  @default(false)
  testedAt          DateTime? @map("tested_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  usage             BotsAiUsage[]

  @@index([enabled])
  @@index([type])
  @@map("bots_ai_providers")
}

// AI Usage Tracking
model BotsAiUsage {
  id              Int      @id @default(autoincrement())
  botId           String   @map("bot_id") @db.VarChar(255)
  providerId      String   @map("provider_id") @db.VarChar(50)
  tokensUsed      Int      @default(0) @map("tokens_used")
  apiCalls        Int      @default(1) @map("api_calls")
  durationSeconds Int?     @map("duration_seconds") // For voice AI (duration in seconds)
  cost            Decimal? @db.Decimal(10, 4) // Cost in USD or credits
  latency         Int?     // Milliseconds
  error           Boolean  @default(false)
  timestamp       DateTime @default(now())

  // Relations
  provider        BotsAiProvider @relation(fields: [providerId], references: [providerId], onDelete: Cascade)

  @@index([botId])
  @@index([providerId])
  @@index([timestamp])
  @@index([botId, providerId, timestamp])
  @@map("bots_ai_usage")
}
